YUI.add("moodle-atto_panoptoltibutton-button",function(m,t){m.namespace("M.atto_panoptoltibutton").PlacementStrategyFactory=function(){this.strategyFor=function(t,e,i,o,n){if(a=m.M.atto_panoptoltibutton.EmbeddedContentRenderingStrategy,"application/vnd.ims.lti.v1.ltilink"===t.mediaType||"application\\/vnd.ims.lti.v1.ltilink"===t.mediaType||t.placementAdvice){var a=m.M.atto_panoptoltibutton.IframeRenderingStrategy;if(t.placementAdvice||t.iframe)switch(t.placementAdvice?.presentationDocumentTarget?t.placementAdvice.presentationDocumentTarget:t.thumbnail?"frame":"iframe"){case"iframe":a=m.M.atto_panoptoltibutton.IframeRenderingStrategy;break;case"embed":case"frame":case"window":case"popup":case"overlay":a=m.M.atto_panoptoltibutton.EmbeddedContentRenderingStrategy;break;default:alert("Unsupported presentation target: "+t.placementAdvice.presentationDocumentTarget)}}return new a(t,e,i,o,n)}},m.namespace("M.atto_panoptoltibutton").EmbeddedContentRenderingStrategy=function(t,e,i,o,n){var a,l,r,s=t.mediaType.split("/"),d=s[0],p="250px",c=72,u=null,h=parseInt(p)-parseInt(72)+"px";switch(t.text&&t.text.length||(p="72px"),t.displayHeight||(t.displayHeight=p),r="",t.thumbnail&&(t.thumbnail.width||(t.thumbnail.width=128),t.thumbnail.height||(t.thumbnail.height=72),t.displayWidth&&(u=parseInt(t.displayWidth)-parseInt(t.thumbnail.width)-5+"px"),c=parseInt(t.thumbnail.height)+"px",r=t.thumbnail.id||t.thumbnail["@id"]),a={ltiLink:m.Handlebars.compile(`
            <iframe src="${M.cfg.wwwroot}/lib/editor/atto/plugins/panoptoltibutton/view.php?custom={{custom}}
                &course={{course.id}}&ltitypeid={{toolid}}&resourcelinkid={{resourcelinkid}}
                {{#if item.url}}&contenturl={{item.url}}{{/if}}"
                {{#if isResponsive}}
                style="width: 100%; height: auto; aspect-ratio: 16 / 9;"
                {{else}}
                {{#if item.placementAdvice.width}} width="{{item.placementAdvice.displayWidth}}"{{/if}}
                {{#if item.placementAdvice.height}} height="{{item.placementAdvice.displayHeight}}"{{/if}}
                {{/if}}
                allowfullscreen="true">
            </iframe>
        `),link:m.Handlebars.compile('<div style="'+(t.displayWidth?"width:{{item.displayWidth}};":"")+'height:{{titleHeight}};"><a href="'+M.cfg.wwwroot+'/lib/editor/atto/plugins/panoptoltibutton/view.php?custom={{custom}}&course={{course.id}}&ltitypeid={{toolid}}&resourcelinkid={{resourcelinkid}}{{#if item.url}}&contenturl={{item.url}}{{/if}}" {{#if item.placementAdvice.windowTarget}}target="{{item.placementAdvice.windowTarget}}" {{/if}}>{{#if item.thumbnail}}<img src={{thumbnailId}} alt="content thumbnail"style="float:left;margin-right:5px;width:{{item.thumbnail.width}}px;height:{{item.thumbnail.height}}px;" /> {{/if}}<div style="float:left;font-size:20px;font-weight:bold;'+(t.titleWidth?"width:{{titleWidth}};":"")+'height:{{titleHeight}};line-height:{{titleHeight}};">{{item.title}}</div></a></div>{{#if item.text}}<div style="'+(t.displayWidth?"width:{{item.displayWidth}};":"")+'min-height:{{textHeight}};"></span>{{item.text}}</span></div>{{/if}}')},d=d.replace(/\\/g,"")){case"application":"vnd.ims.lti.v1.ltilink"===s[1]?l=a.ltiLink({item:t,toolid:o.id,resourcelinkid:i,course:e,isResponsive:n}):alert("Unsupported application subtype");break;case"text":l=a.link({item:t,custom:encodeURIComponent(JSON.stringify(t.custom)),course:e,toolid:o.id,resourcelnkid:i,textHeight:h,titleHeight:c,titleWidth:u,thumbnailId:r});break;default:alert("Unsupported type")}this.toHtml=function(){return l}},m.namespace("M.atto_panoptoltibutton").IframeRenderingStrategy=function(t,e,i,o,n){var a;t.url!==o.baseurl&&t.url!==o.config.toolurl_ContentItemSelectionRequest&&(t.useCustomUrl=!0);let l=t.placementAdvice?.displayWidth?t.placementAdvice.displayWidth:t.iframe?.width,r=t.placementAdvice?.displayHeight?t.placementAdvice.displayHeight:t.iframe?.height;a=m.Handlebars.compile(`
        <iframe src="${M.cfg.wwwroot}/lib/editor/atto/plugins/panoptoltibutton/view.php?course={{courseId}}
            &ltitypeid={{ltiTypeId}}&custom={{custom}}
            {{#if item.useCustomUrl}}&contenturl={{item.url}}{{/if}}
            &resourcelinkid={{resourcelinkid}}"
            {{#if isResponsive}}
            style="width: 100%; height: auto; aspect-ratio: 16 / 9;"
            {{else}}
            style="{{#if displayWidth}}width: {{displayWidth}}px;{{/if}}{{#if displayHeight}} height: {{displayHeight}}px;{{/if}}"
            {{/if}}
            allowfullscreen="true">
        </iframe>
    `),this.toHtml=function(){return a({item:t,custom:JSON.stringify(t.custom),courseId:e.id,resourcelinkid:i,ltiTypeId:o.id,displayHeight:r,displayWidth:l,isResponsive:n})}},require(["core/str"],function(t){var i=null,t=t.get_string("erroroccurred","atto_panoptoltibutton");$.when(t).done(function(t){i=t}),document.CALLBACKS={handleError:function(t){alert(i);for(var e=0;e<t.length;e++)console.error(t[e])}}}),m.namespace("M.atto_panoptoltibutton").Button=m.Base.create("button",m.M.editor_atto.EditorPlugin,[],{_CONTENT_ITEM_SELECTION_URL:M.cfg.wwwroot+"/lib/editor/atto/plugins/panoptoltibutton/contentitem.php",_panel:null,_addTool:function(t,n){t.preventDefault();var a,l=this._createResourceLinkId(),r=this.get("host"),s=this._course,d=this._isResponsive;document.CALLBACKS["f"+l]=function(t){var e,i,o;if(t){for(e=0;e<t["@graph"].length;e++)i=t["@graph"][e],o=(new m.M.atto_panoptoltibutton.PlacementStrategyFactory).strategyFor(i,s,l,n,d).toHtml,r.insertContentAtFocusPoint(o(i));r.saveSelection(),r.updateOriginal(),a.hide(),a.destroy()}},this._panel=new M.core.dialogue({bodyContent:'<iframe src="'+this._CONTENT_ITEM_SELECTION_URL+"?course="+this._course.id+"&id="+n.id+"&callback=f"+l+'" width="100%" height="100%"></iframe>',headerContent:n.name,width:"67%",height:"66%",draggable:!1,visible:!0,zindex:100,modal:!0,focusOnPreviousTargetAfterHide:!0,render:!0}),this._panel.after("visibleChange",this._panel.destroy,this),a=this._panel},initializer:function(t){var e;t.toolTypes&&0!==t.toolTypes.length&&!t.disabled&&(this._course=t.course,this._isResponsive=t.isResponsive,this._createResourceLinkId=(e=t.resourcebase,function(){return e+"_"+(new Date).getTime()}),1<t.toolTypes.length?this.addToolbarMenu({icon:"ed/iconone",iconComponent:"atto_panoptoltibutton",globalItemConfig:{callback:this._addTool},items:t.toolTypes.map(function(t){return{text:t.name,callbackArgs:t}})}):1===t.toolTypes.length&&this.addButton({icon:"ed/iconone",iconComponent:"atto_panoptoltibutton",text:t.toolTypes[0].name??"Panopto LTI",callback:this._addTool,callbackArgs:t.toolTypes[0]}))}})},"@VERSION@",{requires:["moodle-editor_atto-plugin"]});